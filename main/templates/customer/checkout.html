<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f6f9;
        font-family: Arial, sans-serif;
      }

      .container {
        margin-top: 50px;
      }

      .cart-summary {
        margin-bottom: 30px;
      }

      .cart-summary table {
        width: 100%;
        margin-bottom: 20px;
      }

      .cart-summary table th,
      .cart-summary table td {
        padding: 10px;
        text-align: left;
      }

      .cart-summary img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 5px;
      }

      .btn-custom {
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        padding: 10px 20px;
      }

      .btn-custom:hover {
        background-color: #0056b3;
      }

      .message {
        margin-top: 20px;
        text-align: center;
      }

      .cart-summary th, .cart-summary td {
        vertical-align: middle;
      }

      .cart-summary td img {
        margin-right: 15px;
      }

      /* Address form section */
      .form-section {
        margin-top: 30px;
      }

      .form-section h3 {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Checkout</h1>

      {% if messages %}
      <div class="message">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="cart-summary">
        <h3>Your Cart</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Food</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cart.items.all %}
            <tr>
              <!-- نمایش تصویر غذا -->
              <td>
                <img src="{{ item.food.image.url }}" alt="{{ item.food.name }}" />
                {{ item.food.name }}
              </td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.food.price }}$</td>
              <td>{{ item.total_price }}$</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4">Your cart is empty.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p><strong>Total Amount: </strong>{{ total_price }}$</p>
      </div>

      <h3>Apply Discount Code</h3>
      <form method="POST">
        {% csrf_token %}
        <div class="mb-3">
          <label for="discount_code" class="form-label">Discount Code</label>
          <input
            type="text"
            id="discount_code"
            name="discount_code"
            placeholder="Enter your discount code"
            class="form-control"
          />
        </div>
        <p><strong>Discount Applied: </strong>{{ discount_amount }}$</p>
        <p><strong>Final Price: </strong>{{ final_price }}$</p>

        <h3>Delivery Address</h3>
        <hr />
        
        <!-- انتخاب آدرس ذخیره‌شده -->
        <div class="mb-3">
          <label for="existing-address" class="form-label">Select Address</label>
          <select name="address_id" id="existing-address" class="form-control" onchange="toggleNewAddressSection()">
            <option value="">-- Select an Address --</option>
            {% for address in addresses %}
            <option value="{{ address.id }}" {% if address.id == selected_address_id %}selected{% endif %}>{{ address.title }} - {{ address.address }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- بخش آدرس جدید -->
        <div id="new-address-section" style="display: none;">
          <hr />
          <h5>Or Add a New Address</h5>
          <div class="mb-3">
            <label for="title" class="form-label">Title (e.g., Home, Work)</label>
            <input
              type="text"
              id="title"
              name="title"
              placeholder="Title"
              class="form-control"
            />
          </div>
          <div class="mb-3">
            <label for="new-address" class="form-label">Full Address</label>
            <textarea
              id="new-address"
              name="new_address"
              class="form-control"
              rows="3"
              placeholder="Enter your full address"
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input
              type="text"
              id="city"
              name="city"
              placeholder="City"
              class="form-control"
            />
          </div>
          <div class="mb-3">
            <label for="postal-code" class="form-label">Postal Code</label>
            <input
              type="text"
              id="postal-code"
              name="postal_code"
              placeholder="Postal Code"
              class="form-control"
            />
          </div>
        </div>

        <button type="submit" class="btn-custom">Place Order</button>
      </form>
    </div>

    <script>
      function toggleNewAddressSection() {
        var selectElement = document.getElementById('existing-address');
        var newAddressSection = document.getElementById('new-address-section');
        if (selectElement.value === "") {
          newAddressSection.style.display = 'block';
        } else {
          newAddressSection.style.display = 'none';
        }
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
